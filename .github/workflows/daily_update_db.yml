name: Daily Database Update

# Executa todos os dias Ã s 4h UTC (apÃ³s fechamento do mercado brasileiro)
# TambÃ©m pode ser executado manualmente via workflow_dispatch
on:
  schedule:
    # Cron: minuto hora dia-do-mes mes dia-da-semana
    # 0 4 * * * = todos os dias Ã s 4:00 UTC (1:00 BRT)
    - cron: '0 4 * * *'
  
  workflow_dispatch:  # Permite execuÃ§Ã£o manual
    inputs:
      ticker:
        description: 'Ticker para atualizar (ex: B3SA3.SA)'
        required: false
        default: 'B3SA3.SA'

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # NecessÃ¡rio para fazer push
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install yfinance pandas
    
    - name: Verificar se banco de dados existe
      run: |
        if [ ! -f "database/market_data.db" ]; then
          echo "âš ï¸  Banco de dados nÃ£o existe - serÃ¡ criado"
          echo "DB_EXISTS=false" >> $GITHUB_ENV
        else
          echo "âœ… Banco de dados encontrado"
          echo "DB_EXISTS=true" >> $GITHUB_ENV
        fi
    
    - name: Criar banco de dados inicial (se necessÃ¡rio)
      if: env.DB_EXISTS == 'false'
      run: |
        echo "ğŸ“¥ Criando banco de dados com 5 anos de histÃ³rico..."
        python database/populate_db.py --ticker B3SA3.SA --years 5
    
    - name: Atualizar banco de dados
      run: |
        TICKER="${{ github.event.inputs.ticker || 'B3SA3.SA' }}"
        echo "ğŸ”„ Atualizando dados de $TICKER..."
        python database/update_db.py --ticker $TICKER
    
    - name: Verificar mudanÃ§as
      id: check_changes
      run: |
        if git diff --quiet database/market_data.db; then
          echo "Nenhuma mudanÃ§a no banco de dados"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Banco de dados foi atualizado"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit e push das mudanÃ§as
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add database/market_data.db
        git commit -m "chore: atualizaÃ§Ã£o diÃ¡ria do banco de dados [skip ci]"
        git push
    
    - name: Notificar sucesso
      if: success()
      run: |
        echo "âœ… AtualizaÃ§Ã£o do banco de dados concluÃ­da com sucesso!"
        echo "ğŸ“… Data: $(date)"
    
    - name: Notificar falha
      if: failure()
      run: |
        echo "âŒ Falha na atualizaÃ§Ã£o do banco de dados"
        echo "ğŸ“… Data: $(date)"
        exit 1
